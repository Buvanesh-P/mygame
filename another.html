<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BBSSS Game</title>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.80.1/dist/phaser.min.js"></script>
    <style>
        body { 
            margin: 0; 
            padding: 20px; 
            background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 50%, #fecfef 100%); 
            font-family: 'Arial', sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        canvas { 
            border-radius: 20px; 
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            margin-bottom: 20px;
        }
        #instructions {
            text-align: center;
            max-width: 800px;
            color: #fff;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            font-size: 18px;
        }
        h1 {
            color: #ff69b4;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.5);
            margin-bottom: 10px;
        }
        #server-notice {
            color: #ff0000;
            text-align: center;
            font-size: 14px;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <h1>BBSSS</h1>
    <div id="instructions">
        Use arrow keys to move and jump! Collect pink hearts to fill the affection meter.
        Avoid the thorny roses that appear. Get 1000 affection to win! You have 3 lives ‚ù§Ô∏è.
    </div>
    <div id="server-notice" style="display: none;">
        ‚ö†Ô∏è Run via local server (not file://) to avoid CORS errors. Use: <code>python -m http.server 8000</code>
    </div>

    <script>
        // Check if running from file:// protocol
        if (window.location.protocol === 'file:') {
            document.getElementById('server-notice').style.display = 'block';
        }

        const config = {
            type: Phaser.AUTO,
            width: 800,
            height: 600,
            physics: {
                default: 'arcade',
                arcade: {
                    gravity: { y: 400 },
                    debug: false
                }
            },
            scene: {
                preload: preload,
                create: create,
                update: update
            }
        };

        const game = new Phaser.Game(config);

        let player;
        let hearts;
        let platforms;
        let roses;
        let cursors;
        let affection = 0;
        let affectionText;
        let affectionMeter;
        let gameOver = false;
        let win = false;
        let lives = 3;
        let livesText;
        let assetsLoaded = false;

        function preload() {
            // Load local assets - download these to assets/ folder
            // Heart: https://opengameart.org/content/heart-pixel-art (heart.png)
            // Bomb/Rose: https://opengameart.org/content/bomb-sprite (bomb.png)
            // Dude: Original or free alternative like https://opengameart.org/content/lpc-medieval-fantasy-character-sprites (dude.png)
            // Ground: Any platform image or use solid color
            // Sky: Create a 800x600 gradient PNG or use Phaser fill
            
            this.load.image('sky', 'assets/sky.png');
            this.load.image('ground', 'assets/ground.png');
            this.load.image('heart', 'assets/heart.png');
            this.load.image('rose', 'assets/bomb.png');  // Rename bomb to rose.png if preferred
            this.load.spritesheet('dude', 'assets/dude.png', { frameWidth: 32, frameHeight: 48 });

            // Fallback: Load from a CORS-enabled CDN if local assets missing
            if (!this.textures.exists('heart')) {
                console.warn('Local assets not found, using fallbacks...');
                this.load.image('heart', 'https://raw.githubusercontent.com/photonstorm/phaser3-examples/master/public/assets/sprites/star.png');
                this.load.image('rose', 'https://raw.githubusercontent.com/photonstorm/phaser3-examples/master/public/assets/sprites/bomb.png');
                this.load.spritesheet('dude', 'https://labs.phaser.io/assets/sprites/dude.png', { frameWidth: 32, frameHeight: 48 });
            }

            // Listen for load errors
            this.load.on('filecomplete', (key) => {
                console.log(`Asset loaded: ${key}`);
            });
            this.load.on('loaderror', (file) => {
                console.error(`Failed to load ${file.key}. Ensure assets/ folder exists.`);
            });
        }

        function create() {
            // Verify essential assets loaded
            if (!this.textures.exists('heart') || !this.textures.exists('rose') || !this.textures.exists('dude')) {
                this.add.text(400, 300, 'Assets failed to load!\nCreate assets/ folder with:\n- heart.png (pink heart sprite)\n- bomb.png (rose/bomb sprite)\n- dude.png (character spritesheet)\n- ground.png (platform)\n- sky.png (background)\n\nOr serve via local server.', 
                    { fontSize: '16px', fill: '#fff', align: 'center' }).setOrigin(0.5);
                return;
            }
            assetsLoaded = true;

            // Pink dreamy background
            const sky = this.add.image(400, 300, 'sky').setTint(0xffaaff);
            if (!this.textures.exists('sky')) {
                // Fallback: Create gradient rectangle if no sky image
                const graphics = this.add.graphics();
                graphics.fillGradientStyle(0xff9a9e, 0xff9a9e, 0xfecfef, 0xfecfef, 1);
                graphics.fillRect(0, 0, 800, 600);
            }

            // Platforms
            platforms = this.physics.add.staticGroup();
            platforms.create(400, 568, 'ground').setScale(2).refreshBody().setTint(0xff69b4);
            platforms.create(600, 450, 'ground').setTint(0xff1493);
            platforms.create(150, 350, 'ground').setTint(0xff69b4);
            platforms.create(550, 250, 'ground').setTint(0xff1493);
            platforms.create(100, 150, 'ground').setScale(0.7).setTint(0xff69b4);

            if (!this.textures.exists('ground')) {
                // Fallback: Use colored rectangles for platforms
                platforms.clear(true, true);
                platforms.create(400, 568, null).setScale(4, 0.2).setTint(0xff69b4).refreshBody();
                // Add more fallback platforms as needed
            }

            // Player
            player = this.physics.add.sprite(100, 450, 'dude');
            player.setBounce(0.3);
            player.setCollideWorldBounds(true);
            player.setScale(1.2);

            // Animations
            if (this.anims.exists('left') === false) {
                this.anims.create({
                    key: 'left',
                    frames: this.anims.generateFrameNumbers('dude', { start: 0, end: 3 }),
                    frameRate: 10,
                    repeat: -1
                });
                this.anims.create({
                    key: 'turn',
                    frames: [{ key: 'dude', frame: 4 }],
                    frameRate: 20
                });
                this.anims.create({
                    key: 'right',
                    frames: this.anims.generateFrameNumbers('dude', { start: 5, end: 8 }),
                    frameRate: 10,
                    repeat: -1
                });
            }

            // Floating Hearts
            hearts = this.physics.add.group({
                key: 'heart',
                repeat: 14,
                setXY: { x: 12, y: 0, stepX: 55 }
            });
            hearts.children.iterate(child => {
                child.setBounceY(Phaser.Math.FloatBetween(0.5, 0.9));
                child.setTint(0xff69b4);
                child.setScale(1.2);
            });

            // Thorny Roses
            roses = this.physics.add.group();

            // UI Elements
            affectionText = this.add.text(16, 16, 'Affection: 0/1000 üíù', { 
                fontSize: '28px', 
                fill: '#ff69b4',
                fontStyle: 'bold'
            }).setStroke('#fff', 4);

            livesText = this.add.text(16, 60, '‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è', { 
                fontSize: '32px', 
                fill: '#ff0000'
            });

            // Affection Meter
            affectionMeter = this.add.graphics();
            affectionMeter.fillStyle(0x4ec0e8, 1);
            affectionMeter.fillRect(150, 20, 500, 30);
            affectionMeter.lineStyle(4, 0xffffff, 1);
            affectionMeter.strokeRect(150, 20, 500, 30);

            // Physics Colliders
            this.physics.add.collider(player, platforms);
            this.physics.add.collider(hearts, platforms);
            this.physics.add.collider(roses, platforms);
            this.physics.add.overlap(player, hearts, collectHeart, null, this);
            this.physics.add.overlap(player, roses, hitRose, null, this);

            // Controls
            cursors = this.input.keyboard.createCursorKeys();

            // Heart particles for win effect
            this.heartEmitter = this.add.particles(0, 0, 'heart', {
                speed: 100,
                lifespan: 3000,
                blendMode: 'ADD',
                scale: { start: 1, end: 0 },
                tint: 0xff69b4,
                quantity: 0,
                frequency: -1
            });
            this.heartEmitter.setEmitterZone(new Phaser.GameObjects.Zone(400, 300, 800, 600));
        }

        function collectHeart(player, heart) {
            if (gameOver || win) return;
            
            heart.disableBody(true, true);
            affection += 50;
            updateMeter.call(this);

            // Respawn hearts when all collected
            if (hearts.countActive(true) === 0) {
                hearts.children.iterate(child => {
                    child.enableBody(true, child.x, 0, true, true);
                });

                // Spawn a rose for challenge
                let rose = roses.create(Phaser.Math.Between(0, 800), 16, 'rose');
                if (rose) {
                    rose.setBounce(1);
                    rose.setCollideWorldBounds(true);
                    rose.setVelocity(Phaser.Math.Between(-200, 200), 20);
                    rose.setScale(1.1);
                    rose.setTint(0x8b0000);
                }
            }
        }

        function hitRose(player, rose) {
            if (gameOver || win) return;
            
            lives--;
            livesText.setText('‚ù§Ô∏è'.repeat(lives));
            this.tweens.add({
                targets: player,
                alpha: 0.3,
                yoyo: true,
                duration: 200,
                repeat: 5
            });
            rose.destroy();

            if (lives <= 0) {
                gameOver = true;
                this.physics.pause();
                player.setTint(0x8b0000);
                player.anims.play('turn');
                this.add.text(400, 250, 'BBB... üò¢', { 
                    fontSize: '48px', 
                    fill: '#ff69b4' 
                }).setOrigin(0.5);
                this.add.text(400, 320, 'Refresh for another try üíï', { 
                    fontSize: '24px', 
                    fill: '#fff' 
                }).setOrigin(0.5);
            }
        }

        function updateMeter() {
            affectionText.setText('Affection: ' + affection + '/1000 üíù');
            let percent = Math.min(affection / 1000, 1);
            affectionMeter.clear();
            affectionMeter.fillStyle(0xff1493, 1);
            affectionMeter.fillRect(150, 20, 500 * percent, 30);
            affectionMeter.lineStyle(4, 0xffffff, 1);
            affectionMeter.strokeRect(150, 20, 500, 30);

            // WIN!
            if (affection >= 1000 && !win) {
                win = true;
                this.physics.pause();
                this.heartEmitter.explode(200, 400, 300);
                player.anims.play('turn');
                player.setTint(0xffff00);
                this.add.text(400, 250, 'DUDUU! ‚ù§Ô∏èüíç', { 
                    fontSize: '42px', 
                    fill: '#ffd700',
                    fontStyle: 'bold'
                }).setOrigin(0.5);
                this.add.text(400, 320, 'Tadaaa! üòçüéÇ', { 
                    fontSize: '32px', 
                    fill: '#ff69b4' 
                }).setOrigin(0.5);
                this.add.text(400, 380, 'Refresh to play again üíñ', { 
                    fontSize: '20px', 
                    fill: '#fff' 
                }).setOrigin(0.5);
            }
        }

        function update() {
            if (gameOver || win || !assetsLoaded) return;

            // Player movement
            if (cursors.left.isDown) {
                player.setVelocityX(-180);
                player.anims.play('left', true);
            } else if (cursors.right.isDown) {
                player.setVelocityX(180);
                player.anims.play('right', true);
            } else {
                player.setVelocityX(0);
                player.anims.play('turn');
            }

            if (cursors.up.isDown && player.body.touching.down) {
                player.setVelocityY(-360);
            }

            // Fall off = lose life
            if (player.y > 700) {
                lives--;
                livesText.setText('‚ù§Ô∏è'.repeat(lives));
                player.setPosition(100, 450);
                player.setVelocityY(0);
                if (lives <= 0) {
                    hitRose.call(this, player, { destroy: () => {} });
                }
            }
        }
    </script>
</body>
</html>
